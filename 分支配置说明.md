# GitHub Bot 分支配置功能说明

## 功能概述

现在可以为每个仓库单独配置要监控的分支，支持以下几种配置方式：

1. **监控所有分支** - 使用简单字符串格式或 `"*"` 通配符
2. **监控单个分支** - 使用 `branch` 字段指定
3. **监控多个分支** - 使用 `branches` 字段指定数组

## 配置格式

### 方式一：简单字符串（默认监控所有分支）

```json
{
  "github_repos": [
    "owner/repo1",
    "owner/repo2"
  ]
}
```

### 方式二：监控单个分支

```json
{
  "github_repos": [
    {
      "repo": "owner/repo1",
      "branch": "main"
    },
    {
      "repo": "owner/repo2",
      "branch": "develop"
    }
  ]
}
```

### 方式三：监控多个分支

```json
{
  "github_repos": [
    {
      "repo": "owner/repo1",
      "branches": ["main", "dev", "feature/new-feature"]
    }
  ]
}
```

### 方式四：显式监控所有分支

```json
{
  "github_repos": [
    {
      "repo": "owner/repo1",
      "branch": "*"
    }
  ]
}
```

### 方式五：混合配置

```json
{
  "github_repos": [
    "owner/repo1",
    {
      "repo": "owner/repo2",
      "branch": "main"
    },
    {
      "repo": "owner/repo3",
      "branches": ["main", "dev"]
    },
    {
      "repo": "owner/repo4",
      "branch": "*"
    }
  ]
}
```

## 配置示例

完整的配置文件示例（config.json）：

```json
{
  "github_token": "ghp_your_github_token_here",
  "github_repos": [
    {
      "repo": "torvalds/linux",
      "branch": "master"
    },
    {
      "repo": "microsoft/vscode",
      "branches": ["main", "release"]
    },
    {
      "repo": "facebook/react",
      "branch": "*"
    },
    "vercel/next.js"
  ],
  "check_interval": 300,
  "openai_api_key": "sk-your_openai_api_key_here",
  "openai_base_url": "https://api.openai.com/v1",
  "openai_model": "gpt-3.5-turbo",
  "qq_bot_url": "http://127.0.0.1:5700",
  "qq_group_id": "123456789",
  "database_path": "data.db"
}
```

## 使用说明

### 1. 创建配置文件

```bash
python main.py init-config -c config.json
```

### 2. 编辑配置文件

根据上述格式修改 `config.json`，为每个仓库配置要监控的分支。

### 3. 运行监控服务

```bash
python main.py run -c config.json
```

启动后，日志会显示每个仓库监控的分支：

```
🚀 启动GitHub QQ Bot监控服务...
监控仓库: torvalds/linux (分支: master)
监控仓库: microsoft/vscode (分支: main, release)
监控仓库: facebook/react (分支: 所有分支)
监控仓库: vercel/next.js (分支: 所有分支)
检查间隔: 300秒
```

### 4. 测试仓库监控

```bash
python main.py test owner/repo -c config.json
```

### 5. 调试工具

```bash
python debug_tool.py
```

调试工具会显示配置的分支信息：
```
🔗 测试GitHub API连接:
  ✅ 成功获取到 3 个最近提交
  🌱 配置的分支: main, dev
```

## 注意事项

1. **分支名称大小写敏感** - 确保分支名称与GitHub上的完全一致
2. **性能考虑** - 监控多个分支会增加API请求次数，建议合理配置
3. **API限制** - GitHub API有速率限制，监控过多分支可能会超出限制
4. **去重机制** - 同一个提交如果在多个分支上，只会被报告一次

## 实现细节

### 提交去重

当监控多个分支时，同一个提交可能出现在多个分支上。系统会自动根据提交的 SHA 值去重，确保每个提交只被处理和通知一次。

### 数据库存储

仓库的最后检查时间和最后处理的提交 SHA 是按仓库存储的，不区分分支。这意味着：
- 如果一个仓库配置了多个分支，所有分支共享同一个检查时间戳
- 系统会记住最后处理的提交，避免重复通知

### 分支参数传递

系统在调用 GitHub API 时，会根据配置：
- 如果指定了特定分支，使用 `sha` 参数指定分支
- 如果配置为 `"*"` 或空，则获取所有分支的提交
- 多个分支会分别请求后合并去重

## 升级指南

如果你已经有旧的配置文件，可以按以下方式升级：

### 旧格式
```json
{
  "github_repos": ["owner/repo1", "owner/repo2"]
}
```

### 新格式（兼容旧格式）
以上旧格式仍然有效，会默认监控所有分支。

### 新格式（指定分支）
```json
{
  "github_repos": [
    {
      "repo": "owner/repo1",
      "branch": "main"
    },
    {
      "repo": "owner/repo2",
      "branches": ["main", "dev"]
    }
  ]
}
```

## 常见问题

**Q: 如何监控所有分支？**  
A: 使用简单字符串格式 `"owner/repo"` 或 `{"repo": "owner/repo", "branch": "*"}`

**Q: 可以为不同仓库配置不同的分支吗？**  
A: 可以，每个仓库的配置独立，互不影响

**Q: 监控多个分支会收到重复通知吗？**  
A: 不会，系统会自动去重，确保每个提交只通知一次

**Q: 如何知道配置是否生效？**  
A: 启动服务时查看日志，会显示每个仓库监控的分支信息
